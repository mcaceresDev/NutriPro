{% extends "base.njk" %}

{% block pagetitle %}Pacientes{% endblock %}
{% block username %}
  {{ username }}
{% endblock %}

{% block content %}
  <div id="" class="mt-4 table-responsive">

    <div class="d-flex justify-content-between mb-2">
      <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalAgregar">Agregar paciente <i class="fa-solid fa-plus"></i></button>
      <input type="text" id="searchBox" class="search-box form-control form-control-sm" placeholder="Buscar paciente por nombre" />
    </div>
    <div id="patientTable" class="border mt-3">
      {# TABLA DINAMICA #}
    </div>
  </div>

  <div class="modal fade" id="modalAgregar" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalAgregarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="modalAgregarLabel">Agregar nuevo paciente</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="my-2">Los campos con <span class="text-danger">*</span> son obligatorios</p>
          <form id="formRegistrar" class="row g-3">
            <div class="col-md-12">
              <label for="" class="form-label">Nombres <span class="text-danger">*</span></label>
              <input type="text" name="name" class="form-control form-control-sm" id="">
            </div>
            <div class="col-md-12">
              <label for="" class="form-label">Apellidos <span class="text-danger">*</span></label>
              <input type="text" name="lastname" class="form-control form-control-sm" id="">
            </div>
            <div class="col-md-6">
              <label for="inputState" class="form-label">Sexo <span class="text-danger">*</span></label>
              <select name="gender" id="inputState" class="form-select form-select-sm">
                <option selected>Seleccionar</option>
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
              </select>
            </div>
            
            <div class="col-md-6">
              <label for="" class="form-label">Fecha de nacimiento <span class="text-danger">*</span></label>
              <input type="date" name="birthdate" class="form-control form-control-sm" id="">
            </div>
            <div class="col-md-6">
              <label for="" class="form-label">Estatura (M)</label>
              <input type="number" step="any" inputmode="decimal" name="height" class="form-control form-control-sm" id="" placeholder="Especificar altura en metros Ej. 1.80">
            </div>
            <div class="col-6">
              <label for="" class="form-label">Telefono</label>
              <input type="text" name="cellphone" class="form-control form-control-sm" id="" placeholder="">
            </div>
            <div class="col-md-6">
              <label for="inputEmail4" class="form-label">Email</label>
              <input type="email" name="email" class="form-control form-control-sm" id="inputEmail4">
            </div>
            
            <div class="col-md-6">
              <label for="" class="form-label">Numero de responsable</label>
              <input type="text" name="referencePhone" class="form-control form-control-sm" placeholder="Número de emergencia" id="">
            </div>
            <div class="col-md-12">
              <label for="" class="form-label">Nombre de responsable</label>
              <input type="text" name="reference" class="form-control form-control-sm" placeholder="Contacto de emergencia" id="">
            </div>
            <div class="modal-footer d-flex justify-content-center">
              <button type="submit" class="btn btn-success btn-sm">Guardar</button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>

  {# Modal editar paciente #}
  <div class="modal fade" id="modalEditar" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="modalEditarLabel">Editar informacion del paciente</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="my-2">Los campos con <span class="text-danger">*</span> son obligatorios</p>
          <form id="formEditar" class="row g-3">
            <input type="hidden" class="form-control form-control-sm" name="id" id="id" placeholder="">
            <div class="col-md-12">
              <label for="" class="form-label">Nombres <span class="text-danger">*</span></label>
              <input type="text" name="name" class="form-control form-control-sm" id="">
            </div>
            <div class="col-md-12">
              <label for="" class="form-label">Apellidos <span class="text-danger">*</span></label>
              <input type="text" name="lastname" class="form-control form-control-sm" id="">
            </div>
            <div class="col-md-6">
              <label for="inputState" class="form-label">Sexo <span class="text-danger">*</span></label>
              <select name="gender" id="inputState" class="form-select form-select-sm">
                <option selected>Seleccionar</option>
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
              </select>
            </div>
            
            <div class="col-md-6">
              <label for="" class="form-label">Fecha de nacimiento <span class="text-danger">*</span></label>
              <input type="date" name="birthdate" class="form-control form-control-sm" id="">
            </div>
            <div class="col-md-6">
              <label for="" class="form-label">Estatura (M)</label>
              <input type="number" step="any" inputmode="decimal" name="height" class="form-control form-control-sm" id="" placeholder="Especificar altura en metros Ej. 1.80">
            </div>
            <div class="col-6">
              <label for="" class="form-label">Telefono</label>
              <input type="text" name="cellphone" class="form-control form-control-sm" id="" placeholder="">
            </div>
            <div class="col-md-6">
              <label for="inputEmail4" class="form-label">Email</label>
              <input type="email" name="email" class="form-control form-control-sm" id="inputEmail4">
            </div>
            
            <div class="col-md-6">
              <label for="" class="form-label">Numero de telefono</label>
              <input type="text" name="referencePhone" class="form-control form-control-sm" placeholder="Número de emergencia" id="">
            </div>
            <div class="col-md-12">
              <label for="" class="form-label">Nombre de responsable</label>
              <input type="text" name="reference" class="form-control form-control-sm" placeholder="Contacto de emergencia" id="">
            </div>
            <div class="modal-footer d-flex justify-content-center">
              <button type="submit" class="btn btn-success btn-sm">Guardar</button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    const tableData = {{ patients | dump | safe}}
    const tabla = new Tabulator("#patientTable", {
      locale: "es-es",
      langs: LANG.langs,
      data: tableData,
      layout: "fitColumns",
      pagination: "local",
      paginationSize: 10,
      responsiveLayout: true,
      columns: [
        {
          title: "Nombres",
          field: "name"
        }, {
          title: "Apellidos",
          field: "lastname"
        }, {
          title: "Sexo",
          field: "gender"
        },
        {
          title: "Edad",
          field: "age"
        }, 
        {
          title: "Altura (M)",
          field: "height"
        },
        {
          title: "Teléfono",
          field: "cellphone"
        }, {
          title: "Correo",
          field: "email"
        }, {
          title: "Responsable",
          field: "reference"
        }, {
          title: "Telefono de responsable",
          field: "referencePhone"
        }, {
          title: "Acciones",
          formatter: (cell) => {
            const id = cell.getRow().getData().id
            return `
                        <a href="${id}" class="btn btn-primary btn-sm editar"><i class="fa-solid fa-file-waveform"></i></a>
                        <button class="btn btn-warning btn-sm editar" data-bs-toggle="modal" data-bs-target="#modalEditar"><i class="fa-solid fa-pen"></i></button>
                    `
          },
          width: 140,
          cellClick: (e, cell) => {
            const data = cell
              .getRow()
              .getData();

            fillModalForm(data);
            if (e.target.classList.contains("editar")) {
              console.log("Editar:", data);
            }

            if (e.target.classList.contains("eliminar")) {
              console.log("Eliminar:", data);
            }
          }
        }
      ]
    })

    document
      .getElementById("searchBox")
      .addEventListener("keyup", (e) => {
        tabla.setFilter("name", "like", e.target.value);
      });
  </script>
  <script src="/js/sweetAlertHelper.js"></script>
  <script src="/js/patients/patientsCrud.js"></script>
{% endblock %}